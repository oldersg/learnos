## 保护模式进阶
### 获取内存
通过0x15号BIOS中断实现，分别有三个子功能，子功能号放在EAX（AX）中，注意BIOS中断在实模式下，以下只能在实模式中进行

+ eax=0xe820：获取所有物理内存
+ ax=0xe801：检测低15MB和16MB~4GB
+ ah：最多检测64MB

---

### 0xe820

ARDS结构

|  字节偏移量 | 名称  | 描述  |
|---|---|---|
|  0 |  BaseAddrLow | 基地址的低32位  |
| 4  | BaseAddrHigh  | 基地址的高32位  |
| 8  |  LengthLow | 内存长度的低32位，字节为单位  |
| 12  |  LengthHigh | 内存长度的高32位，字节为单位  |
| 16  |  Type | 本段内存类型  |

每次int0x15都会返回一个这种结构  
Type字段具体含义

|  值 | 描述  |
|---|---|
| 1  | 这段内存可以被操作系统使用  |
| 2 | 内存使用中或者系统保留，os无法使用  |
|  其他 | 未定义  |

调用0xe820需要的参数及其含义

|  寄存器 | 用法  |
|---|---|
| EAX  | 固定输入0xe820  |
| EBX | 使用前必须置为0，该值为当前的ARDS下标  |
|  ES:DI | 该值指向的内存为ARDS结构中的值  |
|  ECX | ARDS结构的大小，固定为20字节  |
|  EDX | 签名标记，固定为0x534d4150  |

返回0xe820中寄存器或标志位含义

|  寄存器或标志 | 用法  |
|---|---|
| CF  | 0表示没出错，1表示出错  |
| EAX | 固定为0x534d4150  |
|  ES:DI | 该值指向的内存为ARDS结构中的值  |
|  ECX | ARDS结构的大小，固定为20字节  |
|  EBX | 下一个ARDS，若返回后为0，那么检测结束  |

---

### 0xe801

低于15MB的内存单位为1KB，高于16MB的内存单位为以64KB记录  
具体寄存器功能说明
|  寄存器或标志 | 用法  |
|---|---|
| AX（调用）  | 固定输入0xe801  |
|---|---|
| AX（返回）  | 1KB为单位，最大为0x3c00  |
| CF  | 0表示没出错，1表示出错  |
| BX | 64KB为单位  |
|  CX | 同AX  |
|  DX | 同BX  |

分为两段内存检测原因：实际物理内存和检测内存如下图
![这是图片](../imgs/chapter5/001.png "内存检测")
由于80286的寻址范围最大为16MB，老式ISA设备会使用15MB以上缓存区，但操作系统不可以使用这段（memory hole），实际的物理内存大小要加1MB

---

### 0xe88
此中断只会显示0~63MB，因为不包含低端1MB大小。  
具体寄存器功能说明
|  寄存器或标志 | 用法  |
|---|---|
| AH（调用）  | 固定输入0x88  |
|---|---|
| AX（返回）  | 1KB为单位，不包括低端1MB  |
| CF  | 0表示没出错，1表示出错  |